<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸˆ ê³±ì…ˆ & ë‚˜ëˆ—ì…ˆ ì—°ìŠµ ğŸˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #FFF8E7 0%, #FFE4E1 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 30px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #FF6B6B;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .progress {
            color: #666;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .problem {
            font-size: 3rem;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
        }

        .fraction-box {
            background: #FFFAF0;
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            display: inline-block;
        }

        .fraction-title {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .numerator {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FF6B6B;
        }

        .fraction-line {
            height: 4px;
            background: #333;
            margin: 10px auto;
            width: 80px;
        }

        .denominator {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4ECDC4;
        }

        .fruit-display {
            font-size: 1.5rem;
            margin: 15px 0;
        }

        .explain {
            color: #666;
            font-size: 1.1rem;
            margin: 15px 0;
        }

        .input-group {
            margin: 25px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        input[type="number"] {
            font-size: 2rem;
            width: 120px;
            padding: 15px;
            text-align: center;
            border: 3px solid #ddd;
            border-radius: 15px;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            border-color: #4ECDC4;
        }

        .btn {
            font-size: 1.3rem;
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #4ECDC4;
            color: #333;
        }

        .btn-hint {
            background: #FFE66D;
            color: #333;
        }

        .btn-danger {
            background: #FF6B6B;
            color: #333;
        }

        .btn-orange {
            background: #FF9800;
            color: #333;
        }

        .btn-large {
            font-size: 1.5rem;
            padding: 20px 40px;
            margin: 10px;
        }

        .result {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .result.correct {
            color: #4ECDC4;
        }

        .result.wrong {
            color: #FF6B6B;
        }

        .answer-visual {
            font-size: 1.2rem;
            color: #666;
            margin: 15px 0;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .number-btn {
            font-size: 1.5rem;
            padding: 20px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            color: #333;
            transition: transform 0.2s;
        }

        .number-btn:hover {
            transform: scale(1.05);
        }

        .count-grid {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .mode-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .mode-btn {
            font-size: 1.8rem;
            padding: 30px 40px;
        }

        .selected-info {
            color: #FF6B6B;
            font-size: 1.1rem;
            margin: 15px 0;
        }

        .final-result {
            padding: 20px;
        }

        .score-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
        }

        .percentage {
            font-size: 1.5rem;
            color: #666;
        }

        .emoji-display {
            font-size: 2rem;
            margin: 20px 0;
        }

        .wrong-list {
            text-align: left;
            background: #FFF5F5;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .wrong-list h3 {
            color: #FF6B6B;
            margin-bottom: 10px;
        }

        .wrong-item {
            color: #666;
            padding: 5px 0;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
        .bg-1 { background: #FF6B6B; }
        .bg-2 { background: #4ECDC4; }
        .bg-3 { background: #FFE66D; }
        .bg-4 { background: #95E1D3; }
        .bg-5 { background: #DDA0DD; }
        .bg-6 { background: #87CEEB; }
        .bg-7 { background: #98FB98; }
        .bg-8 { background: #FFB6C1; }

        @media (max-width: 480px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .problem {
                font-size: 2rem;
            }

            .number-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }

            .number-btn {
                font-size: 1.2rem;
                padding: 15px;
            }

            .btn-large {
                font-size: 1.2rem;
                padding: 15px 25px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="start-screen">
            <h1>ğŸˆ ê³±ì…ˆ & ë‚˜ëˆ—ì…ˆ ì—°ìŠµ ğŸˆ</h1>
            <p class="problem">í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹</p>
            <p class="fruit-display">ğŸğŸŠğŸ‹ğŸ‡ğŸ“ğŸ‘ğŸ’ğŸ¥ğŸŒğŸ«</p>
            <p class="explain">ê³¼ì¼ë¡œ ê³±ì…ˆê³¼ ë‚˜ëˆ—ì…ˆì„ ë°°ì›Œë´ìš”!</p>

            <div class="mode-grid">
                <button class="btn btn-danger mode-btn" onclick="selectMode('division')">â— ë‚˜ëˆ—ì…ˆ</button>
                <button class="btn btn-primary mode-btn" onclick="selectMode('multiplication')">âœ–ï¸ ê³±ì…ˆ</button>
            </div>
        </div>

        <!-- ìˆ«ì ì„ íƒ í™”ë©´ -->
        <div id="number-screen" class="hidden">
            <h1 id="number-title">ğŸˆ ë‚˜ëˆ—ì…ˆ ì—°ìŠµ ğŸˆ</h1>
            <p class="explain" id="number-label">â‘  ë‚˜ëˆ„ëŠ” ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>

            <div class="number-grid">
                <button class="number-btn bg-1" onclick="selectNumber(2)">2</button>
                <button class="number-btn bg-2" onclick="selectNumber(3)">3</button>
                <button class="number-btn bg-3" onclick="selectNumber(4)">4</button>
                <button class="number-btn bg-4" onclick="selectNumber(5)">5</button>
                <button class="number-btn bg-5" onclick="selectNumber(6)">6</button>
                <button class="number-btn bg-6" onclick="selectNumber(7)">7</button>
                <button class="number-btn bg-7" onclick="selectNumber(8)">8</button>
                <button class="number-btn bg-8" onclick="selectNumber(9)">9</button>
            </div>
        </div>

        <!-- ë¬¸ì œ ìˆ˜ ì„ íƒ í™”ë©´ -->
        <div id="count-screen" class="hidden">
            <h1 id="count-title">ğŸˆ ë‚˜ëˆ—ì…ˆ ì—°ìŠµ ğŸˆ</h1>
            <p class="selected-info" id="selected-info"></p>
            <p class="explain">â‘¡ ë¬¸ì œ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>

            <div class="count-grid">
                <button class="btn btn-primary btn-large" onclick="startQuiz(10)">10ë¬¸ì œ</button>
                <button class="btn btn-primary btn-large" onclick="startQuiz(20)">20ë¬¸ì œ</button>
                <button class="btn btn-primary btn-large" onclick="startQuiz(50)">50ë¬¸ì œ</button>
            </div>
        </div>

        <!-- í€´ì¦ˆ í™”ë©´ -->
        <div id="quiz-screen" class="hidden">
            <h1 id="quiz-title">ğŸˆ ë‚˜ëˆ—ì…ˆ ì—°ìŠµ ğŸˆ</h1>
            <p class="progress" id="progress"></p>
            <p class="problem" id="problem-text"></p>

            <div class="fraction-box" id="fraction-box">
                <p class="fraction-title">ğŸ“ ë¶„ìˆ˜ë¡œ ë³´ë©´:</p>
                <p class="numerator" id="numerator"></p>
                <div class="fraction-line"></div>
                <p class="denominator" id="denominator"></p>
            </div>

            <p class="fruit-display" id="fruit-display"></p>
            <p class="explain" id="quiz-explain"></p>

            <div class="input-group" id="input-group">
                <input type="number" id="answer-input" placeholder="?" onkeypress="handleKeyPress(event)">
                <button class="btn btn-primary" onclick="checkAnswer()">í™•ì¸</button>
                <button class="btn btn-hint" onclick="showHint()">ğŸ’¡ íŒíŠ¸</button>
            </div>

            <p class="result hidden" id="result-text"></p>
            <p class="answer-visual hidden" id="answer-visual"></p>

            <button class="btn btn-primary btn-large hidden" id="next-btn" onclick="nextProblem()">ë‹¤ìŒ ë¬¸ì œ â¡ï¸</button>
        </div>

        <!-- ê²°ê³¼ í™”ë©´ -->
        <div id="result-screen" class="hidden">
            <h1>ğŸ† ê²°ê³¼ ë°œí‘œ ğŸ†</h1>
            <p class="score-display" id="score-display"></p>
            <p class="emoji-display" id="emoji-display"></p>
            <p class="explain" id="result-message"></p>
            <p class="percentage" id="percentage-display"></p>

            <div class="wrong-list hidden" id="wrong-list">
                <h3>ğŸ“– í‹€ë¦° ë¬¸ì œ:</h3>
                <div id="wrong-items"></div>
            </div>

            <div class="button-group">
                <button class="btn btn-orange btn-large hidden" id="retry-btn" onclick="retryWrong()">ğŸ”„ í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°</button>
                <button class="btn btn-danger btn-large" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'division';
        let selectedNumber = 2;
        let currentProblem = null;
        let wrongProblems = [];

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('number-screen').classList.remove('hidden');

            if (mode === 'division') {
                document.getElementById('number-title').textContent = 'ğŸˆ ë‚˜ëˆ—ì…ˆ ì—°ìŠµ ğŸˆ';
                document.getElementById('number-label').textContent = 'â‘  ë‚˜ëˆ„ëŠ” ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:';
            } else {
                document.getElementById('number-title').textContent = 'ğŸˆ ê³±ì…ˆ ì—°ìŠµ ğŸˆ';
                document.getElementById('number-label').textContent = 'â‘  ê³±í•˜ëŠ” ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:';
            }
        }

        function selectNumber(num) {
            selectedNumber = num;
            document.getElementById('number-screen').classList.add('hidden');
            document.getElementById('count-screen').classList.remove('hidden');

            const title = currentMode === 'division' ? 'ğŸˆ ë‚˜ëˆ—ì…ˆ ì—°ìŠµ ğŸˆ' : 'ğŸˆ ê³±ì…ˆ ì—°ìŠµ ğŸˆ';
            const info = currentMode === 'division' ? `âœ… ë‚˜ëˆ„ê¸° ${num} ì„ íƒë¨!` : `âœ… ê³±í•˜ê¸° ${num} ì„ íƒë¨!`;

            document.getElementById('count-title').textContent = title;
            document.getElementById('selected-info').textContent = info;
        }

        async function startQuiz(count) {
            const response = await fetch('/api/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mode: currentMode,
                    number: selectedNumber,
                    count: count
                })
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById('count-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');
                showProblem(data);
            }
        }

        function showProblem(data) {
            currentProblem = data.problem;
            const total = data.total;
            const index = data.index;
            const correctCount = data.correct_count || 0;

            const title = currentMode === 'division'
                ? `ğŸˆ ë‚˜ëˆ„ê¸° ${selectedNumber} ì—°ìŠµ ğŸˆ`
                : `ğŸˆ ê³±í•˜ê¸° ${selectedNumber} ì—°ìŠµ ğŸˆ`;

            document.getElementById('quiz-title').textContent = title;
            document.getElementById('progress').textContent = `ë¬¸ì œ ${index + 1}/${total} | âœ… ë§ì€ ê°œìˆ˜: ${correctCount}`;

            if (currentMode === 'division') {
                document.getElementById('problem-text').textContent = `${currentProblem.num1} Ã· ${currentProblem.num2} = ?`;
                document.getElementById('fraction-box').classList.remove('hidden');
                document.getElementById('numerator').textContent = currentProblem.num1;
                document.getElementById('denominator').textContent = currentProblem.num2;

                const displayCount = Math.min(currentProblem.num1, 10);
                if (currentProblem.num1 > 10) {
                    document.getElementById('fruit-display').textContent = `ğŸ§º ğŸÃ—${currentProblem.num1}ê°œ`;
                } else {
                    document.getElementById('fruit-display').textContent = 'ğŸ§º ' + 'ğŸ'.repeat(displayCount);
                }
                document.getElementById('quiz-explain').textContent = `ğŸ‘‰ ${currentProblem.num1}ê°œë¥¼ ${currentProblem.num2}ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ ì£¼ë©´?`;
            } else {
                document.getElementById('problem-text').textContent = `${currentProblem.num1} Ã— ${currentProblem.num2} = ?`;
                document.getElementById('fraction-box').classList.add('hidden');
                document.getElementById('fruit-display').textContent = `ğŸ§º ${'ğŸ'.repeat(currentProblem.num1)} Ã— ${currentProblem.num2}ë¬¶ìŒ`;
                document.getElementById('quiz-explain').textContent = `ğŸ‘‰ ${currentProblem.num1}ê°œì”© ${currentProblem.num2}ë¬¶ìŒì´ë©´ ëª¨ë‘ ëª‡ ê°œ?`;
            }

            // ì´ˆê¸°í™”
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').focus();
            document.getElementById('result-text').classList.add('hidden');
            document.getElementById('answer-visual').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('input-group').classList.remove('hidden');
        }

        async function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('answer-input').value);

            if (isNaN(userAnswer)) {
                alert('ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const response = await fetch('/api/answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ answer: userAnswer })
            });

            const data = await response.json();
            const resultText = document.getElementById('result-text');
            const answerVisual = document.getElementById('answer-visual');

            resultText.classList.remove('hidden', 'correct', 'wrong');
            answerVisual.classList.remove('hidden');

            if (data.correct) {
                resultText.textContent = 'ğŸ‰ ì •ë‹µì´ì—ìš”! ğŸ‰';
                resultText.classList.add('correct');
            } else {
                resultText.textContent = `ğŸ˜Š ì •ë‹µì€ ${data.answer}ì´ì—ìš”!`;
                resultText.classList.add('wrong');
            }

            // ì •ë‹µ ì‹œê°í™”
            if (currentMode === 'division') {
                answerVisual.textContent = `ğŸ“¦ ${currentProblem.num2}ëª…ì—ê²Œ ê°ê° ${data.answer}ê°œì”©! (${'â—'.repeat(Math.min(data.answer, 10))})`;
            } else {
                const dots = 'â—'.repeat(Math.min(data.answer, 10)) + (data.answer > 10 ? '...' : '');
                answerVisual.textContent = `ğŸ“¦ ì´ ${data.answer}ê°œ! (${dots})`;
            }

            document.getElementById('input-group').classList.add('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
        }

        async function nextProblem() {
            const response = await fetch('/api/next', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.finished) {
                showFinalResult(data);
            } else {
                showProblem(data);
            }
        }

        function showFinalResult(data) {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');

            document.getElementById('score-display').textContent = `${data.correct_count}/${data.total} ì •ë‹µ!`;
            document.getElementById('percentage-display').textContent = `ì •ë‹µë¥ : ${data.percentage}%`;

            let message, emojis;
            if (data.percentage === 100) {
                message = 'ğŸŒŸ ì™„ë²½í•´ìš”! ì²œì¬ì˜ˆìš”! ğŸŒŸ';
                emojis = 'â­'.repeat(10);
            } else if (data.percentage >= 80) {
                message = 'ğŸ‰ ì•„ì£¼ ì˜í–ˆì–´ìš”! ğŸ‰';
                emojis = 'ğŸ‰'.repeat(8);
            } else if (data.percentage >= 60) {
                message = 'ğŸ‘ ì˜í–ˆì–´ìš”! ğŸ‘';
                emojis = 'ğŸ‘'.repeat(6);
            } else {
                message = 'ğŸ’ª ë‹¤ì‹œ ë„ì „í•´ë´ìš”! ğŸ’ª';
                emojis = 'ğŸ’ª'.repeat(5);
            }

            document.getElementById('result-message').textContent = message;
            document.getElementById('emoji-display').textContent = emojis;

            wrongProblems = data.wrong_problems || [];

            if (wrongProblems.length > 0) {
                document.getElementById('wrong-list').classList.remove('hidden');
                document.getElementById('retry-btn').classList.remove('hidden');

                const wrongItems = document.getElementById('wrong-items');
                wrongItems.innerHTML = '';
                wrongProblems.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'wrong-item';
                    if (currentMode === 'division') {
                        div.textContent = `${p.num1} Ã· ${p.num2} = ${p.answer}`;
                    } else {
                        div.textContent = `${p.num1} Ã— ${p.num2} = ${p.answer}`;
                    }
                    wrongItems.appendChild(div);
                });
            } else {
                document.getElementById('wrong-list').classList.add('hidden');
                document.getElementById('retry-btn').classList.add('hidden');
            }
        }

        async function retryWrong() {
            const response = await fetch('/api/retry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById('result-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');
                document.getElementById('quiz-title').textContent = 'ğŸ”„ í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸° ğŸ”„';
                showProblem(data);
            }
        }

        function showHint() {
            let hint;
            if (currentMode === 'division') {
                hint = `ğŸ’¡ íŒíŠ¸: ğŸ ${currentProblem.num2}ê°œì”© ë¬¶ì–´ë³´ì„¸ìš”!\n${'ğŸ'.repeat(currentProblem.num2)} â† ì´ê²Œ 1ë¬¶ìŒì´ì—ìš”`;
            } else {
                hint = `ğŸ’¡ íŒíŠ¸: ${currentProblem.num1} + ${currentProblem.num1} + ... (${currentProblem.num2}ë²ˆ ë”í•˜ê¸°)\n${currentProblem.num1}ì„ ${currentProblem.num2}ë²ˆ ë”í•´ë³´ì„¸ìš”!`;
            }
            alert(hint);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }

        function goHome() {
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('count-screen').classList.add('hidden');
            document.getElementById('number-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }
    </script>
</body>
</html>
